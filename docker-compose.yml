version: "3.8"  # Compose file format

services:
  rasa:
    image: rasa/rasa:3.6.2-full  # Rasa OSS with full dependencies
    command: [
      "run",
      "--enable-api",
      "--cors",
      "*",
      "--port",
      "5005",
      "--model",
      "/app/models",
      "--endpoints",
      "/app/endpoints.docker.yml",
      "--credentials",
      "/app/credentials.yml"
    ]
    working_dir: /app
    volumes:
      - ./:/app  # Mount project for live iteration
    environment:
      - WEATHERAPI_KEY=${WEATHERAPI_KEY}  # Provide WeatherAPI key to both services
    depends_on:
      - actions

  actions:
    image: rasa/rasa:3.6.2-full  # Rasa SDK action server
    command: [
      "run",
      "actions",
      "--actions",
      "actions.actions"
    ]
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      - WEATHERAPI_KEY=${WEATHERAPI_KEY}

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    ports:
      - "8080:8080"  # Host port -> container port
    depends_on:
      - rasa

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"  # Public HTTP entrypoint
    depends_on:
      - web
      - rasa

networks:
  default:
    name: weatherbot_net  # Fixed network name for clarity when inspecting
